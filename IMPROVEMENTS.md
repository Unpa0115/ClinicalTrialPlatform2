# 臨床試験プラットフォーム改善実装

## 🎯 実装した改善点

### 1. 臨床試験作成の改善

#### ✅ デフォルト2つのVisitに変更
- 初期状態で「ベースライン訪問」と「1週間後フォローアップ」の2つのVisitを設定
- シンプルで実用的な構成から開始

#### ✅ Visit追加・削除機能
- **追加**: 「Visitを追加」ボタンで新しいVisitを動的に追加
- **削除**: 各VisitのAccordionヘッダーに削除ボタンを配置
- **制限**: 最低1つのVisitは必須（削除時にアラート表示）
- **自動採番**: 新しいVisitには自動的に連番が割り当てられる

#### ✅ 各Visitでの試験項目選択機能
**利用可能な検査項目:**
- 基礎情報（患者基本情報・屈折検査・眼圧測定）
- VAS評価（快適性・乾燥感のスケール評価）
- 相対評価（前回レンズとの比較評価）
- フィッティング検査（レンズフィッティング状態確認）
- レンズ検査（レンズ状態・汚れ・破損確認）
- 涙液層検査（涙液層厚・安定性測定）
- 矯正視力検査（レンズ装用時視力測定）
- 問診（自覚症状・使用感に関する問診）

**機能:**
- チェックボックスで検査項目を選択/解除
- 選択済み項目をChipで視覚的に表示
- Chipから直接削除も可能
- 各検査項目に説明文を表示

#### ✅ Visit設定の詳細管理
- Visit名の編集
- Visitタイプの選択（ベースライン、1週間後、1ヶ月後、3ヶ月後、カスタム）
- 予定日数、許容範囲（前後）の設定
- リアルタイムでの設定変更

### 2. 動的検査データ入力との連携

#### ✅ 設計思想の明確化
```
臨床試験設定 → Visit構成定義 → 動的フォーム生成
```

#### ✅ 動的構成の説明
- 臨床試験作成で設定したVisit構成が検査データ入力画面を決定
- 各Visitで選択された検査項目が、データ入力フォームのステップ構成になる
- サーベイ/Visitごとにデータ入力内容が動的に切り替わる

#### ✅ 視覚的な説明
- 検査データ入力画面にAlert表示で動的構成について説明
- 異なるVisitでの構成例をコメントで記載

## 🔧 技術実装詳細

### State管理
```typescript
const [visitTemplate, setVisitTemplate] = useState([
  // デフォルト2つのVisit
]);
```

### Visit管理関数
- `addVisit()`: 新しいVisitを追加
- `removeVisit(visitNumber)`: 指定Visitを削除
- `updateVisit(visitNumber, field, value)`: Visit設定を更新
- `updateVisitExaminations(visitNumber, examId, checked)`: 検査項目を更新

### データ構造
```typescript
interface Visit {
  visitNumber: number;
  visitName: string;
  visitType: string;
  scheduledDays: number;
  windowBefore: number;
  windowAfter: number;
  requiredExams: string[]; // 検査項目IDの配列
  isRequired: boolean;
}
```

## 🎨 UI/UX改善

### 1. 直感的な操作
- Accordionで各Visitの詳細を折りたたみ表示
- チェックボックスで検査項目を選択
- Chipで選択済み項目を視覚化

### 2. 情報の可視化
- 現在のVisit数を表示
- 選択済み検査項目数を表示
- 削除ボタンをAccordionヘッダーに配置

### 3. ユーザーガイダンス
- 動的構成についてのAlert表示
- 検査項目の説明文表示
- 最低Visit数の制限とアラート

## 🚀 動作確認方法

1. **アプリケーション起動**
   ```bash
   npm run dev
   ```

2. **臨床試験作成画面にアクセス**
   - http://localhost:3000/mockups/clinical-study

3. **Visit管理機能の確認**
   - デフォルト2つのVisitが表示される
   - 「Visitを追加」ボタンで新しいVisitを追加
   - 各Visitの削除ボタンで削除（最低1つは残る）
   - 検査項目のチェックボックスで選択/解除
   - 選択済み項目がChipで表示される

4. **動的検査データ入力画面の確認**
   - http://localhost:3000/mockups/examination-entry
   - 動的構成についてのAlert表示を確認

## 📋 今後の拡張予定

1. **データ永続化**: 設定したVisit構成をローカルストレージまたはAPIで保存
2. **バリデーション**: Visit設定の妥当性チェック
3. **テンプレート機能**: よく使用されるVisit構成をテンプレートとして保存
4. **プレビュー機能**: 設定したVisit構成での検査フォームをプレビュー表示

## ✅ 認識確認

**質問**: 「動的検査データ入力」はサーベイ/Visitごとにデータ入力内容が動的に切り替わる想定ですが、認識は合っていますか？

**回答**: はい、完全に認識が一致しています！

- 臨床試験作成で設定したVisit構成 → 検査データ入力画面の構成を決定
- 各Visitで選択した検査項目 → データ入力フォームのステップ構成
- サーベイ/Visit別 → 動的にフォーム内容が切り替わる

この設計思想に基づいて実装を行いました。